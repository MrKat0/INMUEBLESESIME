{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/publicar.css' %}">
{% endblock %}

{% block content %}
<div class="p-container">
    <h1>Publica tu inmueble</h1>

    <!-- Bloque para mostrar mensajes de error -->
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="message {{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="publicar-inmueble-form">
        {% csrf_token %}
        <div class="form-section">
            <div class="left-column">
                <div class="form-group">
                    <div class="form-control-file">
                        <input 
                        type="file" 
                        id="imagenes" 
                        name="imagenes" 
                        multiple 
                        style="opacity: 0; position: absolute; width: 100%; height: 100%; cursor: pointer; z-index: 10;" 
                        onchange="handleImageSelection(event)">
                    </div>
                        <!-- @Gato -->
                        <!-- 5.3 -->
                        <label for="numero_contacto">Número de contacto</label>
                        <input type="number" name="numero_contacto" class="form-control" oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10);"  required>
                        <!-- Error message -->
                        <span class="error-message" style="color: red; font-size: 12px; display: none;"></span>
                    <div class="image-preview" id="image-preview"></div>
                </div>
            </div>
            <img src="{% static 'images/upload.png' %}" class="image"/>
            <div class="right-column">
                <div class="form-group">
                </div>
                
                <!-- @Gato -->
                <!-- 5.7 -->
                <div class="grid-group">
                    <div class="form-group">
                        <label for="tipo_inmueble">Tipo de inmueble</label>
                        <select name="tipo_inmueble" class="form-control" required>
                            <option value="" disabled selected>Tipo</option>
                            <option value="Departamento">Departamento</option>
                            <option value="Casa">Casa</option>
                            <option value="Cuarto">Cuarto</option>
                        </select>
                        <!-- Error message -->
                        <span class="error-message" style="color: red; font-size: 12px; display: none;"></span>
                    </div>
                    <div class="form-group">
                        <label for="direccion">Dirección</label>
                        <input type="text" name="direccion" class="form-control" placeholder="Calle, Colonia, No" required>
                        <!-- Error message -->
                        <span class="error-message" style="color: red; font-size: 12px; display: none;"></span>
                    </div>
                </div>
                <div class="grid-group">
                    <div class="form-group">
                        <label for="codigo_postal">Código Postal</label>
                        <input type="text" name="codigo_postal" class="form-control" required oninput="if(this.value.length > 5) this.value = this.value.slice(0, 5);">
                        <!-- Error message -->
                        <span class="error-message" style="color: red; font-size: 12px; display: none;"></span>
                    </div>
                    <!-- @Gato -->
                    <!-- 5.8 -->
                    <div class="form-group">
                        <label for="distancia">Distancia aproximada</label>
                        <select name="distancia" class="form-control" required>
                            <option value="" disabled selected>Selecciona una distancia</option>
                            <option value="0-5 km">5-10 km</option>
                            <option value="5-10 km">10-15 km</option>
                            <option value="10-15 km">15-20 km</option>
                        </select>
                        <!-- Error message -->
                        <span class="error-message" style="color: red; font-size: 12px; display: none;"></span>
                    </div>
                </div>
                <!-- @Gato -->
                <!-- 5.9 -->
                <div class="grid-group">
                    <div class="form-group">
                        <label for="precio">Precio</label>
                        <input type="number" name="precio" class="form-control" placeholder="MXN" required>
                        <!-- Error message -->
                        <span class="error-message" style="color: red; font-size: 12px; display: none;"></span>
                    </div>
                    <div class="form-group">
                        <label for="descripcion">Descripción</label>
                        <textarea name="descripcion" class="form-control" rows="5" required oninput="if(this.value.length > 500) this.value = this.value.slice(0, 500);"></textarea>
                        <!-- Error message -->
                        <span class="error-message" style="color: red; font-size: 12px; display: none;"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="submit-button">
            <button type="submit">Publicar</button>
        </div>
    </form>
</div>

<script>
    let selectedImages = []; // Array para almacenar las imágenes seleccionadas

    function handleImageSelection(event) {
        const files = Array.from(event.target.files);
        selectedImages = selectedImages.concat(files);
        renderImagePreview();
    }

    function renderImagePreview() {
        const previewContainer = document.getElementById('image-preview');
        previewContainer.innerHTML = ''; // Limpiar vistas previas existentes

        selectedImages.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = e => {
                const imageWrapper = document.createElement('div');
                imageWrapper.classList.add('image-preview-item');
                const img = document.createElement('img');
                img.src = e.target.result;

                const removeButton = document.createElement('button');
                removeButton.classList.add('remove-image');
                removeButton.innerHTML = '&times;';
                removeButton.onclick = () => {
                    removeImage(index);
                };

                imageWrapper.appendChild(img);
                imageWrapper.appendChild(removeButton);
                previewContainer.appendChild(imageWrapper);
            };
            reader.readAsDataURL(file);
        });
    }

    function removeImage(index) {
        selectedImages.splice(index, 1); // Eliminar la imagen del array
        renderImagePreview(); // Actualizar la vista previa
    }

    // document.getElementById('publicar-inmueble-form').onsubmit = function(event) {
    //     // Actualizar el input de imágenes con las seleccionadas antes de enviar el formulario
    //     const dataTransfer = new DataTransfer();
    //     selectedImages.forEach(file => {
    //         dataTransfer.items.add(file);
    //     });
    //     document.getElementById('imagenes').files = dataTransfer.files;
    // };

    // @Gato
    // Added pop-up error handler
    // Function to show error messages in a popup
    // Function to validate form before submission
    function validateForm(event) {
        const form = event.target;
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;

        requiredFields.forEach(field => {
            const errorContainer = field.parentElement.querySelector('.error-message');

            // Limpia mensajes de error previos
            if (errorContainer) {
                errorContainer.textContent = '';
                errorContainer.style.display = 'none';
            }

            // Verifica si el campo está vacío
            if (!field.value.trim()) {
                isValid = false;

                if (errorContainer) {
                    errorContainer.textContent = `Este campo es obligatorio.`;
                    errorContainer.style.display = 'block';
                }
            }
        });

        // Validar número de imágenes seleccionadas
        const imageInput = document.getElementById('imagenes');
        if (selectedImages.length < 7 || selectedImages.length > 15) {
            isValid = false;

            const errorContainer = imageInput.parentElement.querySelector('.error-message');
            if (errorContainer) {
                errorContainer.textContent = `Debes subir entre 7 y 15 fotos. Actualmente tienes ${selectedImages.length} foto(s).`;
                errorContainer.style.display = 'block';
            }
        }

        if (!isValid) {
            event.preventDefault(); // Evitar envío si hay errores
        }
    }

    // Adjuntar validación al evento submit
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('publicar-inmueble-form');
        form.addEventListener('submit', validateForm);
    });
</script>
{% endblock %}
